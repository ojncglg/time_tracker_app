<!DOCTYPE html>
<html lang="en">
  <!--
    Template: admin_requests.html (grouped)
    Visual refresh only. No logic or routes changed.
  -->
  <head>
    <meta charset="UTF-8" />
    <title>Admin ‚Ä¢ Pending Requests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>

  <body class="theme-dark min-h-screen">
    <div class="max-w-6xl mx-auto p-6 space-y-6 animate-fade-in">
      {% include '_toasts.html' %}

      <header class="mb-2">
        <h1 class="text-4xl font-bold tracking-tight">
          Pending Time-Off Requests
        </h1>
        <p class="mt-2 text-sm muted">
          Grouped by user & contiguous date range. Actions are per day.
        </p>
      </header>

      {% if groups and groups|length > 0 %}
      <div class="space-y-6">
        {% for g in groups %} {% set t = (g.type or '')|lower %} {% set emoji =
        'üèñÔ∏è' if t == 'vacation' else ('üè•' if t == 'sick' else 'üìÑ') %}

        <div class="card overflow-hidden">
          <!-- Card header -->
          <div
            class="p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
            style="border-bottom: 1px solid var(--border)"
          >
            <div class="flex items-start gap-3">
              <span class="emoji" aria-hidden="true">{{ emoji }}</span>
              <div>
                <div class="text-sm muted">
                  {{ g.rank }} ‚Ä¢ {{ g.call_sign }} ‚Ä¢ {{ g.sector }}
                </div>
                <div class="text-lg font-semibold">
                  {{ g.user_label }} ‚Äî {{ g.type }} ({{ '%.2f' % g.hours_per_day
                  }}h/day)
                </div>
              </div>
            </div>
            <div class="text-sm">
              {% if g.start_date == g.end_date %} {{ g.start_date }} {% else %}
              {{ g.start_date }} ‚Äì {{ g.end_date }} {% endif %}
            </div>
          </div>

          <!-- Per-day rows with Approve/Deny -->
          <div>
            {% for d in g.days %} {% set status = (d.status or '')|lower %}
            <div
              class="p-4 flex items-center justify-between gap-4"
              style="border-top: 1px solid var(--border)"
            >
              <div class="flex items-center gap-3 min-w-0">
                <div class="text-sm font-medium">{{ d.date }}</div>
                <div class="text-xs muted">{{ '%.2f' % d.hours }}h</div>
                {% if d.note %}
                <div
                  class="text-xs muted italic truncate max-w-[40ch]"
                  title="{{ d.note }}"
                >
                  ‚Äú{{ d.note }}‚Äù
                </div>
                {% endif %}
              </div>

              {% if status == 'pending' %}
              <div class="flex items-center gap-2">
                <!-- Approve (unchanged POST) -->
                <form action="{{ url_for('handle_request') }}" method="POST">
                  <input
                    type="hidden"
                    name="_csrf"
                    value="{{ csrf_token() }}"
                  />
                  <input type="hidden" name="user" value="{{ g.user }}" />
                  <input type="hidden" name="date" value="{{ d.date }}" />
                  <input type="hidden" name="action" value="approve" />
                  <input
                    type="submit"
                    value="Approve"
                    class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-700 text-white text-sm font-semibold"
                  />
                </form>

                <!-- Deny (unchanged POST) -->
                <form action="{{ url_for('handle_request') }}" method="POST">
                  <input
                    type="hidden"
                    name="_csrf"
                    value="{{ csrf_token() }}"
                  />
                  <input type="hidden" name="user" value="{{ g.user }}" />
                  <input type="hidden" name="date" value="{{ d.date }}" />
                  <input type="hidden" name="action" value="deny" />
                  <input
                    type="submit"
                    value="Deny"
                    class="px-3 py-1 rounded-md bg-red-600 hover:bg-red-700 text-white text-sm font-semibold"
                  />
                </form>
              </div>
              {% else %} {% if status == 'approved' %}
              <span class="badge badge--success">Approved</span>
              {% elif status in ['denied', 'cancelled', 'canceled'] %}
              <span class="badge badge--danger">
                {{ 'Cancelled' if status in ['cancelled','canceled'] else
                'Denied' }}
              </span>
              {% elif status == 'logged' %}
              <span class="badge">Logged</span>
              {% elif status == 'pending' %}
              <span class="badge badge--gold">Pending</span>
              {% else %}
              <span class="badge">{{ status|capitalize or 'Unknown' }}</span>
              {% endif %} {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card card--loose">
        <p class="muted">No pending requests right now.</p>
      </div>
      {% endif %}

      <!-- Back -->
      <div class="text-center">
        <a href="{{ url_for('landing') }}" class="btn"> ‚Üê Back to Dashboard </a>
      </div>
    </div>
  </body>
</html>
